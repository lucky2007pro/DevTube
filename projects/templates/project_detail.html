{% extends 'base.html' %}
{% load static %}
{% load markdown_extras %}

{# --- 1. SEO VA META TAGLAR (HEAD ICHIGA TUSHADI) --- #}
{% block title %}{{ project.title }} | DevTube{% endblock %}

{% block description %}{{ project.description|truncatewords:20 }}{% endblock %}

{% block og_title %}{{ project.title }} - ${{ project.price }}{% endblock %}
{% block og_description %}{{ project.description|truncatewords:30 }}{% endblock %}

{% block og_image %}
    {% if project.image %}
        {# Agar rasm Cloudinarydan kelsa (http bilan boshlansa), o'zini qo'yamiz #}
        {% if project.image.url|slice:":4" == "http" %}
            {{ project.image.url }}
        {# Aks holda (lokal rasm bo'lsa), sayt nomini qo'shamiz #}
        {% else %}
            {{ request.scheme }}://{{ request.get_host }}{{ project.image.url }}
        {% endif %}
    {% else %}
        {{ request.scheme }}://{{ request.get_host }}{% static 'img/devtube-banner.png' %}
    {% endif %}
{% endblock %}

{% block extra_head %}
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:title" content="{{ project.title }} - DevTube">
    <meta property="og:description" content="{{ project.description|truncatewords:20 }}">

    {# --- Rasm URLini aqlli tekshirish --- #}
    {% if project.image %}
        {% if project.image.url|slice:":4" == "http" %}
            {# Agar Cloudinary link bo'lsa (http bilan boshlansa) o'zini qo'yamiz #}
            <meta property="og:image" content="{{ project.image.url }}">
        {% else %}
            {# Agar lokal rasm bo'lsa, sayt nomini qo'shamiz #}
            <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ project.image.url }}">
        {% endif %}
    {% else %}
        {# Rasm bo'lmasa, standart banner #}
        <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'img/devtube-banner.png' %}">
    {% endif %}
{% endblock %}

{% block content %}
<style>
    /* --- MARKDOWN STYLES (NEON) --- */
    .project-description h1, .project-description h2, .project-description h3 {
        color: #fff; margin-top: 25px; margin-bottom: 15px; font-weight: 800; letter-spacing: -0.5px;
    }
    .project-description p { color: #cbd5e1; margin-bottom: 15px; line-height: 1.8; font-size: 15px; }
    .project-description ul, .project-description ol { color: #cbd5e1; padding-left: 20px; margin-bottom: 20px; }
    .project-description li { margin-bottom: 8px; }

    /* Kod bo'laklari (inline) */
    .project-description code {
        background: rgba(99, 102, 241, 0.15); color: #a5b4fc;
        padding: 2px 6px; border-radius: 6px; font-family: 'Fira Code', monospace; font-size: 0.9em;
        border: 1px solid rgba(99, 102, 241, 0.2);
    }

    /* Kod bloklari (pre) */
    .project-description pre {
        background: #0f172a; padding: 20px; border-radius: 16px;
        overflow-x: auto; border: 1px solid rgba(255, 255, 255, 0.08);
        margin: 20px 0; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }
    .project-description pre code {
        background: transparent; color: #e2e8f0; padding: 0; border: none; font-size: 13px;
    }

    /* Iqtiboslar */
    .project-description blockquote {
        border-left: 4px solid var(--neon-primary);
        padding: 15px 20px; background: rgba(255, 255, 255, 0.03);
        border-radius: 0 12px 12px 0; margin: 20px 0;
        color: #94a3b8; font-style: italic;
    }

    .project-description img {
        max-width: 100%; border-radius: 12px; margin: 20px 0;
        border: 1px solid rgba(255,255,255,0.1);
    }

    /* --- ASOSIY LAYOUT --- */
    :root {
        --neon-primary: #6366f1;
        --neon-secondary: #a855f7;
        --glass-bg: rgba(22, 27, 34, 0.85);
        --border-color: rgba(255, 255, 255, 0.08);
    }

    .project-container {
        max-width: 1200px; margin: 0 auto; display: grid;
        grid-template-columns: 3fr 1fr; gap: 30px;
    }

    @media (max-width: 992px) {
        .project-container { grid-template-columns: 1fr; }
        .info-panel { position: static !important; }
    }

    /* --- CARDS & PANELS --- */
    .neon-preview-card {
        background: var(--glass-bg);
        backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--border-color); border-radius: 16px;
        overflow: hidden; margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .preview-header {
        padding: 15px 20px; background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
    }
    .preview-title { font-weight: 600; color: #cbd5e1; font-size: 14px; letter-spacing: 0.5px; text-transform: uppercase; }

    /* --- VISUAL PREVIEW --- */
    .visual-preview {
        width: 100%; height: 450px; background-color: #0d1117;
        display: flex; align-items: center; justify-content: center;
        position: relative; overflow: hidden;
    }
    .preview-content { width: 100%; height: 100%; border: none; background: #fff; }
    .preview-image { width: 100%; height: 100%; object-fit: contain; background: #000; }

    /* --- CODE SECTION --- */
    .code-lock-wrapper { position: relative; background: #0d1117; border-radius: 0 0 16px 16px; }
    .code-content {
        font-family: 'Fira Code', 'Consolas', monospace; font-size: 13px;
        padding: 20px; margin: 0; overflow-x: auto; line-height: 1.6; color: #e6edf3;
        max-height: 500px;
    }

    /* Qulf rejimi */
    .locked-mode .code-content {
        max-height: 250px; overflow: hidden;
        filter: blur(5px); opacity: 0.6;
        user-select: none; pointer-events: none;
        -webkit-mask-image: linear-gradient(to bottom, black 20%, transparent 100%);
        mask-image: linear-gradient(to bottom, black 20%, transparent 100%);
    }

    .neon-lock-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: linear-gradient(to bottom, transparent 0%, rgba(13, 17, 23, 0.8) 50%, #0d1117 100%);
        z-index: 10;
    }
    .lock-icon-box {
        width: 70px; height: 70px; background: rgba(245, 158, 11, 0.1);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        border: 2px solid rgba(245, 158, 11, 0.3); margin-bottom: 20px;
        box-shadow: 0 0 25px rgba(245, 158, 11, 0.2);
    }

    /* --- ACTIONS --- */
    .insta-actions-bar { display: flex; align-items: center; gap: 25px; margin: 15px 0; padding: 0 10px; }
    .insta-btn {
        background: none; border: none; padding: 0; color: #fff; opacity: 0.8;
        transition: all 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .insta-btn i { font-size: 28px; }
    .insta-btn:hover { opacity: 1; transform: scale(1.1); }
    .insta-btn.liked i { color: #ef4444; animation: heartPop 0.3s forwards; font-weight: 900; opacity: 1; }
    .insta-btn.saved i { color: #f59e0b; font-weight: 900; opacity: 1; }
    @keyframes heartPop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
    .likes-count-text { font-weight: 700; color: #fff; font-size: 15px; margin-left: 10px; display: block; }

    /* --- SIDEBAR --- */
    .info-panel { position: sticky; top: 90px; }
    .neon-price-card {
        background: var(--glass-bg); backdrop-filter: blur(16px);
        border: 1px solid var(--border-color); padding: 30px 20px;
        border-radius: 16px; text-align: center; margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    .price-tag {
        font-size: 36px; font-weight: 800; color: #fff; display: block; margin: 15px 0 25px;
        background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .price-tag.free { color: #4ade80; -webkit-text-fill-color: #4ade80; }

    .btn-action {
        width: 100%; padding: 14px; border: none; border-radius: 12px;
        font-weight: 700; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;
        text-decoration: none; transition: all 0.3s; margin-bottom: 12px;
    }
    .btn-buy { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
    .btn-download { background: linear-gradient(135deg, #10b981, #059669); color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
    .btn-video { background: rgba(255, 255, 255, 0.05); color: #e2e8f0; border: 1px solid rgba(255, 255, 255, 0.1); }
    .btn-video:hover { background: rgba(255, 255, 255, 0.1); color: #fff; border-color: #ef4444; }

    .author-card {
        background: var(--glass-bg); padding: 15px; border-radius: 16px;
        border: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px;
    }

    /* --- COMMENTS --- */
    .comment-box { background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 15px; border: 1px solid var(--border-color); margin-bottom: 15px; }
    .form-control-dark {
        background: #0d1117; border: 1px solid var(--border-color); color: #fff;
        border-radius: 12px; padding: 15px; font-size: 14px; resize: none;
    }

    /* --- MODAL --- */
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.9); z-index: 2000;
        align-items: center; justify-content: center; backdrop-filter: blur(8px);
    }
    .modal-content-box {
        position: relative; width: 90%; max-width: 900px; background: #000;
        border-radius: 16px; overflow: hidden; box-shadow: 0 0 40px rgba(99, 102, 241, 0.2); border: 1px solid rgba(255,255,255,0.1);
    }
    .close-modal {
        position: absolute; top: -45px; right: 0; color: #fff; font-size: 35px; cursor: pointer; transition: 0.3s;
    }
    .close-modal:hover { color: #ef4444; transform: rotate(90deg); }
</style>

<div class="project-container">

    <div class="main-column">

        <div class="neon-preview-card">
            <div class="preview-header">
                <span class="preview-title">
                    {% if live_preview %}<i class="fas fa-play-circle text-primary me-2"></i> Live Preview{% else %}<i class="fas fa-image text-warning me-2"></i> Screenshot{% endif %}
                </span>
                <span class="badge {% if live_preview %}bg-primary{% else %}bg-secondary{% endif %} bg-opacity-75 rounded-pill px-3">
                    {% if live_preview %}Interactive{% else %}Static{% endif %}
                </span>
            </div>
            <div class="visual-preview">
                {% if live_preview %}
                    <iframe src="{% url 'live_project_view' project.slug %}" class="preview-content" sandbox="allow-scripts allow-modals allow-forms allow-same-origin" loading="lazy"></iframe>
                {% else %}
                    {% if project.image %}
                        <img src="{{ project.image.url }}" class="preview-image" alt="{{ project.title }}">
                    {% else %}
                        <div class="text-center py-5 opacity-25"><i class="fas fa-laptop-code fa-4x mb-3 text-secondary"></i><p class="small">Ko'rinish mavjud emas</p></div>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <div class="neon-preview-card">
            <div class="preview-header">
                <span class="preview-title"><i class="fas fa-code me-2 text-info"></i> Manba Kodi</span>
                <div class="d-flex align-items-center gap-2">
                    {% if has_bought or project.price == 0 %}
                        <button class="btn btn-sm btn-dark border-secondary rounded-pill px-3 text-light" onclick="copyCode()" id="copyBtn">
                            <i class="fas fa-copy me-1"></i> Nusxalash
                        </button>
                    {% endif %}
                    <span class="badge bg-dark border border-secondary text-light rounded-pill px-3 font-monospace">
                        {{ project.source_code.name|default:"main.py"|slice:"14:" }}
                    </span>
                </div>
            </div>

            <div class="code-lock-wrapper {% if not has_bought and project.price > 0 %}locked-mode{% endif %}">
                <pre class="code-content"><code id="sourceCode" class="language-python">{% if has_bought or project.price == 0 %}{{ code_content }}{% else %}{{ code_content|slice:":600" }}

# --------------------------------------------------------
# üîí PREMIUM KOD (PREVIEW)
# To'liq ko'rish uchun loyihani xarid qiling.
# --------------------------------------------------------{% endif %}</code></pre>

                {% if not has_bought and project.price > 0 %}
                    <div class="neon-lock-overlay">
                        <div class="lock-icon-box"><i class="fas fa-lock fa-2x text-warning"></i></div>
                        <h4 class="text-white fw-bold mb-1">Premium Kod</h4>
                        <p class="text-secondary small mb-3">To'liq kodni ochish uchun xarid qiling</p>
                        <a href="#buy-section" class="btn btn-warning rounded-pill fw-bold px-4 shadow-lg text-dark">
                            <i class="fas fa-shopping-cart me-2"></i> ${{ project.price }} ga Olish
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="neon-preview-card mb-4">
    <div class="preview-header">
        <span class="preview-title"><i class="fas fa-shield-alt text-success me-2"></i> Xavfsizlik Tahlili</span>
        {% if project.is_scanned %}
            <span class="badge {% if project.security_status == 'safe' %}bg-success{% elif project.security_status == 'danger' %}bg-danger{% else %}bg-warning text-dark{% endif %} bg-opacity-75 rounded-pill px-3">
                {{ project.get_security_status_display }}
            </span>
        {% else %}
             <span class="badge bg-secondary bg-opacity-50 rounded-pill px-3" id="scan-status-badge">
                 <i class="fas fa-sync fa-spin me-1"></i> Tekshirilmoqda
             </span>
        {% endif %}
    </div>

    <div class="p-4" id="ai-analysis-container">
        {% if project.is_scanned %}
            <div class="alert {% if project.security_status == 'safe' %}alert-success border-success{% elif project.security_status == 'danger' %}alert-danger border-danger{% else %}alert-warning border-warning{% endif %} bg-opacity-10 text-white d-flex align-items-center gap-3 mb-3">
                <div class="fs-1">{% if project.security_status == 'safe' %}üõ°Ô∏è{% elif project.security_status == 'danger' %}üíÄ{% else %}‚ö†Ô∏è{% endif %}</div>
                <div>
                    <h6 class="fw-bold m-0">
                        {% if project.security_status == 'safe' %}Kod toza va xavfsiz{% elif project.security_status == 'danger' %}Diqqat! Zararli kod{% else %}Shubhali qismlar mavjud{% endif %}
                    </h6>
                    <small class="opacity-75">AI tahlili natijasi</small>
                </div>
            </div>
            <div class="bg-dark bg-opacity-50 p-3 rounded-3 border border-secondary border-opacity-25">
                <small class="text-uppercase fw-bold text-info" style="font-size: 11px; letter-spacing: 1px;">GEMINI AI XULOSASI:</small>
                <p class="text-light mt-2 small opacity-90 mb-0">
                    <i class="fas fa-robot text-primary me-2"></i> {{ project.ai_analysis|default:"Tahlil xulosasi mavjud emas." }}
                </p>
            </div>
        {% else %}
            <div class="text-center py-4">
                <div class="spinner-grow text-primary mb-3" role="status"></div>
                <p class="text-muted small">Gemini AI loyihani zararli kodlarga tekshirmoqda... <br>Natija bir necha soniyadan so'ng chiqadi.</p>
            </div>
        {% endif %}
    </div>
</div>

        <div class="px-2">
            <div class="insta-actions-bar">
                <button id="like-btn" data-like-url="{% url 'like_project' project.pk %}" class="insta-btn {% if request.user in project.likes.all %}liked{% endif %}">
                    <i class="{% if request.user in project.likes.all %}fas{% else %}far{% endif %} fa-heart"></i>
                </button>
                <button onclick="document.getElementById('comment-body').focus()" class="insta-btn">
                    <i class="far fa-comment"></i>
                </button>
                <button id="save-btn" onclick="toggleSave({{ project.pk }})" data-save-url="{% url 'save_project' project.pk %}" class="insta-btn ms-auto {% if request.user in project.saved_by.all %}saved{% endif %}">
                    <i class="{% if request.user in project.saved_by.all %}fas{% else %}far{% endif %} fa-bookmark"></i>
                </button>
            </div>
            <span class="likes-count-text"><span id="like-count">{{ project.likes.count }}</span> ta "Yoqdi"</span>

            <div class="d-flex justify-content-between align-items-start mb-3 mt-4">
                <h1 class="text-white fw-bold m-0" style="font-size: 2rem;">{{ project.title }}</h1>
                <button class="btn btn-outline-primary btn-sm rounded-pill px-3 fw-bold {% if is_synced %}active bg-primary text-white{% endif %}" id="syncBtn" onclick="toggleSync()">
                    <i class="fas fa-sync-alt me-2"></i> <span id="syncText">{% if is_synced %}Sinxronlashdi{% else %}Sinxronlash{% endif %}</span>
                </button>
            </div>

            <div class="d-flex flex-wrap gap-3 text-secondary mb-4 small">
                <span><i class="fas fa-eye me-1 text-primary"></i> {{ project.views }} ko'rish</span>
                <span><i class="far fa-calendar-alt me-1 text-success"></i> {{ project.created_at|date:"d.m.Y" }}</span>
                <span class="text-light bg-secondary bg-opacity-25 px-2 rounded">{{ project.get_category_display }}</span>
            </div>

            <div class="project-description mb-5">
                {{ project.description|markdown|safe }}
            </div>
            <div class="row mt-5">
                <div class="col-12">
                    <div class="p-4 rounded-4 border border-secondary border-opacity-25"
                         style="background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px);">

                        <div class="d-flex align-items-center justify-content-between mb-4">
                            <h3 class="fw-bold text-white m-0">Sharhlar va Reyting</h3>
                            <div class="d-flex align-items-center gap-2">
                                <span class="fs-2 fw-bold text-white">{{ avg_rating }}</span>
                                <div class="text-warning fs-5">
                                    <i class="fas fa-star"></i>
                                </div>
                                <span class="text-muted small">({{ reviews.count }} ta ovoz)</span>
                            </div>
                        </div>

                        {% if can_review %}
                        <div class="mb-5 p-3 rounded-3"
                             style="background: rgba(99, 102, 241, 0.1); border: 1px dashed var(--neon-primary);">
                            <h5 class="text-white mb-3">Loyihani baholang:</h5>
                            <form method="post">
                                {% csrf_token %}
                                <div class="rating-css mb-3">
                                    <div class="star-icon">
                                        <input type="radio" name="rating" value="1" id="rating1">
                                        <label for="rating1" class="fa fa-star"></label>
                                        <input type="radio" name="rating" value="2" id="rating2">
                                        <label for="rating2" class="fa fa-star"></label>
                                        <input type="radio" name="rating" value="3" id="rating3">
                                        <label for="rating3" class="fa fa-star"></label>
                                        <input type="radio" name="rating" value="4" id="rating4">
                                        <label for="rating4" class="fa fa-star"></label>
                                        <input type="radio" name="rating" value="5" id="rating5" checked>
                                        <label for="rating5" class="fa fa-star"></label>
                                    </div>
                                </div>

                                <textarea name="comment" class="form-control bg-dark text-white border-secondary mb-3"
                                          rows="3" placeholder="Loyiha haqida fikringiz (ixtiyoriy)..."></textarea>

                                <button type="submit" class="btn btn-primary fw-bold px-4">
                                    <i class="fas fa-paper-plane me-2"></i> Yuborish
                                </button>
                            </form>
                        </div>
                        {% elif user_review %}
                        <div class="alert alert-success d-flex align-items-center gap-2">
                            <i class="fas fa-check-circle"></i> Siz bu loyihaga allaqachon baho bergansiz.
                        </div>
                        {% endif %}

                        <div class="reviews-list">
                            {% for review in reviews %}
                            <div class="d-flex gap-3 mb-4 pb-4 border-bottom border-secondary border-opacity-10">
                                <img src="https://ui-avatars.com/api/?name={{ review.user.username }}&background=random"
                                     class="rounded-circle" width="40" height="40">

                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold text-white">{{ review.user.username }}</span>
                                        <span class="text-muted small" style="font-size: 11px;">{{ review.created_at|timesince }} oldin</span>
                                    </div>

                                    <div class="text-warning small my-1">
                                        {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                        <i class="fas fa-star"></i>
                                        {% else %}
                                        <i class="far fa-star opacity-25"></i>
                                        {% endif %}
                                        {% endfor %}
                                    </div>

                                    <p class="text-light opacity-75 m-0 small">{{ review.comment }}</p>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center text-muted py-3">
                                <i class="far fa-comment-dots fa-2x mb-2 opacity-25"></i>
                                <p>Hozircha sharhlar yo'q. Birinchi bo'ling!</p>
                            </div>
                            {% endfor %}
                        </div>

                    </div>
                </div>
            </div>

            <style>
                /* Yulduzcha reyting uchun maxsus CSS */
                .rating-css div { color: #ffe400; font-size: 20px; font-family: sans-serif; font-weight: 800; text-transform: uppercase; padding: 10px 0; }
                .rating-css input { display: none; }
                .rating-css input + label { font-size: 20px; text-shadow: 1px 1px 0 #ffe400; cursor: pointer; }
                .rating-css input:checked + label ~ label { color: #838383; }
                .rating-css label:active { transform: scale(0.8); transition: 0.3s ease; }
                /* Yulduzchalar teskari tartibda bo'lishi kerak CSS input mantiqida */
                .star-icon { direction: rtl; display: inline-flex; }
            </style>
            <h5 class="text-white mb-3 fw-bold"><i class="far fa-comments me-2"></i>Izohlar (<span id="comment-count-txt">{{ project.comments.count }}</span>)</h5>

            {% if user.is_authenticated %}
                <div class="d-flex gap-3 mb-4">
                    <img src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ user.username }}{% endif %}" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                    <form id="comment-form" method="post" class="w-100 position-relative">
                        {% csrf_token %}
                        <textarea id="comment-body" name="body" class="form-control-dark w-100" placeholder="Ushbu kod haqida fikringiz..." rows="2"></textarea>
                        <button type="submit" class="btn btn-primary btn-sm rounded-pill px-3 position-absolute bottom-0 end-0 m-2 fw-bold"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            {% else %}
                <div class="alert alert-dark opacity-75 small">Izoh yozish uchun <a href="{% url 'login' %}">kiring</a>.</div>
            {% endif %}

            <div id="comment-list">
                {% for comment in project.comments.all reversed %}
                <div class="comment-box d-flex gap-3">
                    <img src="{% if comment.user.profile.avatar %}{{ comment.user.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ comment.user.username }}{% endif %}" class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover;">
                    <div>
                        <div class="d-flex gap-2 align-items-center mb-1">
                            <strong class="text-white small">{{ comment.user.username }}</strong>
                            <small class="text-muted" style="font-size: 11px;">{{ comment.created_at|timesince }} oldin</small>
                        </div>
                        <p class="mb-0 text-light opacity-75 small">{{ comment.body }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="right-column">
        <div class="info-panel" id="buy-section">
            <div class="neon-price-card">
                <span class="text-muted small text-uppercase fw-bold ls-1" style="font-size: 10px;">Loyiha Narxi</span>
                {% if project.price > 0 %}
                    <span class="price-tag">${{ project.price }}</span>
                {% else %}
                    <span class="price-tag free">BEPUL</span>
                {% endif %}

                {% if request.user == project.author or has_bought or project.price == 0 %}

                {% if project.source_code %}
                <a href="{{ project.source_code.url }}"
                   class="btn btn-success w-100 py-3 mb-3 rounded-4 shadow-lg fw-bold" download>
                    <i class="fas fa-cloud-download-alt me-2"></i> Yuklash
                </a>
                {% else %}
                <button class="btn btn-secondary w-100 py-3 mb-3 rounded-4 shadow-lg fw-bold" disabled>
                    <i class="fas fa-exclamation-triangle me-2"></i> Kod yuklanmagan
                </button>
                {% endif %}

                {% if request.user == project.author %}
                <a href="{% url 'update_project' project.pk %}"
                   class="btn btn-warning w-100 py-3 mb-3 rounded-4 shadow-lg fw-bold">
                    <i class="fas fa-edit me-2"></i> Tahrirlash
                </a>
                {% endif %}

                {% else %}

                <form action="{% url 'buy_project' project.pk %}" method="POST"
                      onsubmit="return confirm('Hisobingizdan ${{ project.price }} yechiladi. Tasdiqlaysizmi?')">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary w-100 py-3 mb-3 rounded-4 shadow-lg fw-bold">
                        <i class="fas fa-shopping-cart me-2"></i> Xarid Qilish (${{ project.price }})
                    </button>
                </form>

                {% endif %}

                {% if project.get_youtube_id %}
                    <button class="btn-action btn-video" onclick="openVideoModal()">
                        <i class="fab fa-youtube text-danger fa-lg"></i> Video Sharh
                    </button>
                {% endif %}
            </div>

            <div class="author-card">
                <a href="{% url 'profile_by_username' project.author.username %}">
                    <img src="{% if project.author.profile.avatar %}{{ project.author.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ project.author.username }}{% endif %}" class="rounded-circle border border-2 border-primary" style="width: 45px; height: 45px;">
                </a>
                <div class="flex-grow-1" style="line-height: 1.2;">
                    <a href="{% url 'profile_by_username' project.author.username %}" class="text-white text-decoration-none fw-bold d-block mb-1">{{ project.author.username }}</a>
                    <div class="text-muted" style="font-size: 11px;"><i class="fas fa-code me-1"></i> Dasturchi</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="videoModal" class="modal-overlay" onclick="closeVideoModal(event)">
    <span class="close-modal" onclick="closeVideoModal(event)">&times;</span>
    <div class="modal-content-box">
        <div class="ratio ratio-16x9">
            <iframe id="youtubeIframe" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>
    </div>
</div>

<script>
    // VIDEO MODAL LOGIC
    const youtubeId = "{{ project.get_youtube_id }}";

    function openVideoModal() {
        if(youtubeId) {
            document.getElementById('youtubeIframe').src = "https://www.youtube.com/embed/" + youtubeId + "?autoplay=1&rel=0";
            document.getElementById('videoModal').style.display = "flex";
            document.body.style.overflow = "hidden";
        } else {
            alert("Video ID topilmadi!");
        }
    }

    function closeVideoModal(e) {
        if (e.target.classList.contains('modal-overlay') || e.target.classList.contains('close-modal')) {
            document.getElementById('videoModal').style.display = "none";
            document.getElementById('youtubeIframe').src = "";
            document.body.style.overflow = "auto";
        }
    }

    // NUSXALASH
    function copyCode() {
        const codeText = document.getElementById('sourceCode').innerText;
        navigator.clipboard.writeText(codeText).then(() => {
            const btn = document.getElementById('copyBtn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Saqlandi';
            btn.classList.replace('btn-dark', 'btn-success');
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.classList.replace('btn-success', 'btn-dark');
            }, 2000);
        });
    }

    // SINXRONLASH
    function toggleSync() {
        const btn = document.getElementById('syncBtn');
        const txt = document.getElementById('syncText');
        const icon = btn.querySelector('i');

        fetch("{% url 'toggle_sync' project.author.username %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
            if(data.is_synced) {
                btn.classList.add('active', 'bg-primary', 'text-white');
                txt.innerText = 'Sinxronlashdi';
                icon.classList.add('fa-spin');
                setTimeout(() => icon.classList.remove('fa-spin'), 1000);
            } else {
                btn.classList.remove('active', 'bg-primary', 'text-white');
                txt.innerText = 'Sinxronlash';
            }
        });
    }

    // LIKE BOSISH
    document.getElementById('like-btn').addEventListener('click', function(e) {
        e.preventDefault();
        const url = this.getAttribute('data-like-url');
        const icon = this.querySelector('i');
        const countSpan = document.getElementById('like-count');
        const btn = this;

        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
            countSpan.innerText = data.total_likes;
            if (data.is_liked) {
                icon.classList.replace('far', 'fas');
                btn.classList.add('liked');
            } else {
                icon.classList.replace('fas', 'far');
                btn.classList.remove('liked');
            }
        });
    });

    // SAQLASH (Optimallashtirilgan yagona funksiya)
    function toggleSave(id) {
        const btn = document.getElementById('save-btn');
        const icon = btn.querySelector('i');
        const url = btn.getAttribute('data-save-url');

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(res => res.json())
        .then(data => {
            if(data.is_saved) {
                icon.classList.replace('far', 'fas');
                btn.classList.add('saved');
            } else {
                icon.classList.replace('fas', 'far');
                btn.classList.remove('saved');
            }
        })
        .catch(err => console.error("Xatolik:", err));
    }

    // IZOH QOLDIRISH
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const btn = this.querySelector('button[type="submit"]');
            btn.disabled = true;

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    const html = `
                        <div class="comment-box d-flex gap-3">
                            <img src="${data.avatar_url || 'https://ui-avatars.com/api/?name=' + data.username}" class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover;">
                            <div>
                                <div class="d-flex gap-2 align-items-center mb-1">
                                    <strong class="text-white small">${data.username}</strong>
                                    <small class="text-muted" style="font-size: 11px;">hozirgina</small>
                                </div>
                                <p class="mb-0 text-light opacity-75 small">${data.body}</p>
                            </div>
                        </div>`;
                    document.getElementById('comment-list').insertAdjacentHTML('afterbegin', html);
                    document.getElementById('comment-body').value = '';
                    const countSpan = document.getElementById('comment-count-txt');
                    countSpan.innerText = parseInt(countSpan.innerText || 0) + 1;
                }
            })
            .finally(() => { btn.disabled = false; });
        });
    }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
{% endblock %}