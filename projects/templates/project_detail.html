{% extends 'base.html' %}
{% load static %}
{% load markdown_extras %}

{# --- SEO META --- #}
{% block title %}{{ project.title }} | DevTube{% endblock %}
{% block description %}{{ project.description|truncatewords:20 }}{% endblock %}
{% block og_title %}{{ project.title }} - ${{ project.price }}{% endblock %}

{% block extra_head %}
    <meta property="og:type" content="website">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<style>
    /* --- ASOSIY LAYOUT --- */
    :root {
        --neon-primary: #6366f1;
        --neon-secondary: #a855f7;
        --glass-bg: rgba(15, 23, 42, 0.8);
        --border-color: rgba(255, 255, 255, 0.08);
    }

    .project-container {
        max-width: 1100px; /* Biroz ixchamlashtirildi */
        margin: 0 auto;
        display: grid;
        grid-template-columns: 2.5fr 1fr; /* Chap tomon kengroq, o'ng tomon ixcham */
        gap: 25px;
        padding-top: 20px;
    }

    @media (max-width: 992px) {
        .project-container { grid-template-columns: 1fr; }
        .info-panel { position: static !important; margin-top: 20px; }
    }

    /* --- CARDS & PANELS --- */
    .neon-card {
        background: var(--glass-bg);
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .card-header-custom {
        padding: 12px 18px;
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
    }
    .header-title { font-weight: 600; color: #cbd5e1; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }

    /* --- VISUAL PREVIEW --- */
    .preview-box {
        width: 100%; height: 400px; /* Balandlik biroz kamaytirildi */
        background-color: #0d1117;
        display: flex; align-items: center; justify-content: center;
        overflow: hidden;
    }
    .preview-img { width: 100%; height: 100%; object-fit: contain; }

    /* --- CODE BLOCK --- */
    .code-wrapper { position: relative; background: #0d1117; }
    .code-content {
        font-family: 'Fira Code', monospace; font-size: 12px; /* Shrift kichraytirildi */
        padding: 15px; margin: 0; overflow: auto;
        max-height: 350px; line-height: 1.5; color: #e6edf3;
        background: transparent !important;
        border: none !important;
    }

    /* Qulf rejimi */
    .locked-mode .code-content {
        max-height: 200px; overflow: hidden;
        filter: blur(4px); opacity: 0.5;
        user-select: none; pointer-events: none;
        mask-image: linear-gradient(to bottom, black 30%, transparent 100%);
    }

    .lock-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: rgba(13, 17, 23, 0.6); z-index: 10;
    }

    /* --- SECURITY ANALYSIS --- */
    .ai-analysis-box {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        padding: 15px;
        border: 1px solid var(--border-color);
    }

    /* --- DESCRIPTION --- */
    .project-desc { color: #cbd5e1; font-size: 15px; line-height: 1.7; margin-top: 20px; }
    .project-desc h1, .project-desc h2 { color: #fff; font-size: 1.4rem; margin-top: 20px; margin-bottom: 10px; }
    .project-desc ul { padding-left: 20px; margin-bottom: 15px; }

    /* --- SIDEBAR --- */
    .info-panel { position: sticky; top: 90px; }
    .price-display {
        font-size: 32px; font-weight: 800; color: #fff; display: block; margin: 10px 0 20px;
        background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .price-display.free { color: #4ade80; -webkit-text-fill-color: #4ade80; }

    .action-btn {
        width: 100%; padding: 12px; border: none; border-radius: 10px;
        font-weight: 700; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;
        text-decoration: none; transition: 0.2s; margin-bottom: 10px; cursor: pointer;
    }
    .btn-primary-neon { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
    .btn-primary-neon:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5); color: white; }

    /* --- AI CHAT WIDGET (YANGI) --- */
    .ai-fab {
        position: fixed; bottom: 30px; right: 30px;
        width: 55px; height: 55px;
        background: linear-gradient(135deg, var(--neon-primary), var(--neon-secondary));
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 0 20px rgba(99, 102, 241, 0.6);
        z-index: 1000; transition: transform 0.3s; border: 2px solid white;
    }
    .ai-fab:hover { transform: scale(1.1) rotate(10deg); }
    .ai-fab i { font-size: 24px; color: white; }

    .ai-chat-window {
        position: fixed; bottom: 95px; right: 30px;
        width: 320px; height: 450px;
        background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px);
        border: 1px solid var(--neon-primary); border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        display: none; flex-direction: column; z-index: 1000; overflow: hidden;
        animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .ai-header {
        background: linear-gradient(90deg, var(--neon-primary), var(--neon-secondary));
        padding: 12px 15px; color: white; font-weight: bold; font-size: 14px;
        display: flex; justify-content: space-between; align-items: center;
    }
    .ai-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }

    .ai-msg { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 13px; line-height: 1.4; }
    .ai-msg.bot { background: rgba(255, 255, 255, 0.1); color: #e2e8f0; align-self: flex-start; border-bottom-left-radius: 2px; }
    .ai-msg.user { background: var(--neon-primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

    .ai-input-area { padding: 12px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 8px; }
    .ai-input {
        background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
        color: white; border-radius: 20px; padding: 6px 12px; flex-grow: 1; outline: none; font-size: 13px;
    }
    .ai-send-btn {
        background: white; color: var(--neon-primary); border: none;
        width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .typing-indicator { font-size: 11px; color: #94a3b8; margin-left: 15px; margin-bottom: 5px; display: none; }
</style>

<div class="project-container">

    <div class="main-column">

        <div class="neon-card">
            <div class="card-header-custom">
                <span class="header-title">
                    {% if live_preview %}<i class="fas fa-play-circle text-primary me-2"></i> Live Preview{% else %}<i class="fas fa-image text-warning me-2"></i> Screenshot{% endif %}
                </span>
                <span class="badge {% if live_preview %}bg-primary{% else %}bg-secondary{% endif %} bg-opacity-50 rounded-pill px-3" style="font-size: 10px;">
                    {% if live_preview %}Interactive{% else %}Static{% endif %}
                </span>
            </div>
            <div class="preview-box">
                {% if live_preview %}
                    <iframe src="{% url 'live_project_view' project.slug %}" class="preview-img" sandbox="allow-scripts allow-modals allow-forms allow-same-origin" loading="lazy"></iframe>
                {% else %}
                    {% if project.image %}
                        <img src="{{ project.image.url }}" class="preview-img" alt="{{ project.title }}">
                    {% else %}
                        <div class="text-center opacity-25"><i class="fas fa-laptop-code fa-3x mb-2"></i><p class="small m-0">Rasm yo'q</p></div>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <div class="neon-card">
            <div class="card-header-custom">
                <span class="header-title"><i class="fas fa-code me-2 text-info"></i> Manba Kodi</span>
                <div class="d-flex gap-2">
                    {% if has_bought or project.price == 0 %}
                        <button class="btn btn-sm btn-dark border-secondary rounded-pill px-3 py-1 text-light" onclick="copyCode()" id="copyBtn" style="font-size: 11px;">
                            <i class="fas fa-copy me-1"></i> Nusxalash
                        </button>
                    {% endif %}
                </div>
            </div>

            <div class="code-wrapper {% if not has_bought and project.price > 0 %}locked-mode{% endif %}">
                <pre class="code-content"><code id="sourceCode" class="language-python">{% if has_bought or project.price == 0 %}{{ code_content }}{% else %}{{ code_content|slice:":400" }}

# üîí PREMIUM KOD (PREVIEW)
# To'liq ko'rish uchun xarid qiling.{% endif %}</code></pre>

                {% if not has_bought and project.price > 0 %}
                    <div class="lock-overlay">
                        <i class="fas fa-lock fa-2x text-warning mb-2"></i>
                        <h6 class="text-white fw-bold mb-1">Premium Kod</h6>
                        <small class="text-secondary mb-3">To'liq versiya uchun xarid qiling</small>
                        <a href="#buy-section" class="btn btn-warning rounded-pill fw-bold px-4 py-1 text-dark text-decoration-none" style="font-size: 12px;">
                            Xarid qilish
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="neon-card mb-4">
            <div class="card-header-custom">
                <span class="header-title"><i class="fas fa-shield-alt text-success me-2"></i> Xavfsizlik</span>
                {% if project.is_scanned %}
                    <span class="badge {% if project.security_status == 'safe' %}bg-success{% elif project.security_status == 'danger' %}bg-danger{% else %}bg-warning text-dark{% endif %} bg-opacity-75 rounded-pill px-2" style="font-size: 10px;">
                        {{ project.get_security_status_display }}
                    </span>
                {% else %}
                     <span class="badge bg-secondary bg-opacity-50 rounded-pill px-2" style="font-size: 10px;">
                         <i class="fas fa-sync fa-spin me-1"></i> Tekshirilmoqda
                     </span>
                {% endif %}
            </div>

            <div class="p-3">
                {% if project.is_scanned %}
                    <div class="ai-analysis-box">
                        <small class="text-uppercase fw-bold text-info d-block mb-1" style="font-size: 10px; letter-spacing: 1px;">AI XULOSASI:</small>
                        <p class="text-light opacity-90 mb-0 small" style="font-size: 13px;">
                            <i class="fas fa-robot text-primary me-2"></i> {{ project.ai_analysis|default:"Tahlil xulosasi mavjud emas." }}
                        </p>
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary spinner-border-sm mb-2" role="status"></div>
                        <p class="text-muted small m-0">Kod tekshirilmoqda...</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-start mb-2 px-1">
            <h1 class="text-white fw-bold m-0" style="font-size: 1.8rem;">{{ project.title }}</h1>
            <div class="d-flex gap-2">
                <button id="like-btn" data-like-url="{% url 'like_project' project.pk %}" class="btn btn-dark border-secondary rounded-circle" style="width: 40px; height: 40px;">
                    <i class="{% if request.user in project.likes.all %}fas text-danger{% else %}far text-light{% endif %} fa-heart"></i>
                </button>
                <button id="save-btn" data-save-url="{% url 'save_project' project.pk %}" onclick="toggleSave({{ project.pk }})" class="btn btn-dark border-secondary rounded-circle" style="width: 40px; height: 40px;">
                    <i class="{% if request.user in project.saved_by.all %}fas text-warning{% else %}far text-light{% endif %} fa-bookmark"></i>
                </button>
            </div>
        </div>

        <div class="d-flex gap-3 text-secondary mb-4 small px-1">
            <span><i class="fas fa-eye me-1"></i> {{ project.views }}</span>
            <span><i class="far fa-calendar-alt me-1"></i> {{ project.created_at|date:"d.m.Y" }}</span>
            <span class="text-light bg-secondary bg-opacity-25 px-2 rounded">{{ project.get_category_display }}</span>
        </div>

        <div class="project-desc mb-5 px-1">
            {{ project.description|markdown|safe }}
        </div>

        <div class="neon-card p-4">
            <h5 class="text-white fw-bold mb-3"><i class="far fa-comments me-2"></i>Izohlar va Reyting</h5>

            <div class="d-flex align-items-center gap-3 mb-4 p-3 rounded bg-dark bg-opacity-50 border border-secondary border-opacity-25">
                <div class="d-flex align-items-center gap-2">
                    <span class="fs-3 fw-bold text-white">{{ avg_rating }}</span>
                    <div class="text-warning"><i class="fas fa-star"></i></div>
                </div>
                <div class="vr bg-secondary opacity-50"></div>
                <span class="text-muted small">{{ reviews.count }} ta ovoz</span>

                {% if can_review %}
                    <button class="btn btn-sm btn-outline-primary ms-auto" data-bs-toggle="collapse" data-bs-target="#ratingForm">Baho berish</button>
                {% endif %}
            </div>

            <div class="collapse mb-3" id="ratingForm">
                <form method="post" class="p-3 bg-primary bg-opacity-10 rounded border border-primary border-opacity-25">
                    {% csrf_token %}
                    <label class="small text-white mb-2">Baho:</label>
                    <select name="rating" class="form-select form-select-sm bg-dark text-white border-secondary mb-2" style="width: 100px;">
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
                    </select>
                    <textarea name="comment" class="form-control form-control-sm bg-dark text-white border-secondary mb-2" rows="2" placeholder="Fikringiz..."></textarea>
                    <button type="submit" class="btn btn-sm btn-primary">Yuborish</button>
                </form>
            </div>

            {% if user.is_authenticated %}
                <form method="post" class="d-flex gap-2 mb-4">
                    {% csrf_token %}
                    <img src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ user.username }}{% endif %}" class="rounded-circle" width="32" height="32">
                    <div class="flex-grow-1 position-relative">
                        <textarea name="body" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="Izoh qoldirish..." rows="1"></textarea>
                        <button type="submit" class="btn btn-link text-primary position-absolute end-0 top-0 p-1" style="font-size: 14px;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </form>
            {% endif %}

            <div id="comment-list" class="d-flex flex-column gap-3">
                {% for comment in project.comments.all reversed %}
                <div class="d-flex gap-3 pb-2 border-bottom border-secondary border-opacity-10">
                    <img src="{% if comment.user.profile.avatar %}{{ comment.user.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ comment.user.username }}{% endif %}" class="rounded-circle" width="32" height="32">
                    <div>
                        <div class="d-flex gap-2 align-items-center">
                            <strong class="text-white small">{{ comment.user.username }}</strong>
                            <small class="text-muted" style="font-size: 10px;">{{ comment.created_at|timesince }}</small>
                        </div>
                        <p class="mb-0 text-light opacity-75 small">{{ comment.body }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted small text-center m-0">Hozircha izohlar yo'q.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="right-column">
        <div class="info-panel" id="buy-section">
            <div class="neon-card p-4 text-center">
                <span class="text-muted small text-uppercase fw-bold ls-1" style="font-size: 10px;">Loyiha Narxi</span>
                {% if project.price > 0 %}
                    <span class="price-display">${{ project.price }}</span>
                {% else %}
                    <span class="price-display free">BEPUL</span>
                {% endif %}

                {% if request.user == project.author or has_bought or project.price == 0 %}
                    {% if project.source_code %}
                    <a href="{{ project.source_code.url }}" class="action-btn btn-primary-neon" download>
                        <i class="fas fa-cloud-download-alt"></i> Yuklash
                    </a>
                    {% endif %}

                    {% if request.user == project.author %}
                    <a href="{% url 'update_project' project.pk %}" class="action-btn btn-dark border border-secondary text-warning">
                        <i class="fas fa-edit"></i> Tahrirlash
                    </a>
                    {% endif %}
                {% else %}
                    <form action="{% url 'buy_project' project.pk %}" method="POST" onsubmit="return confirm('Xaridni tasdiqlaysizmi?')">
                        {% csrf_token %}
                        <button type="submit" class="action-btn btn-primary-neon">
                            <i class="fas fa-shopping-cart"></i> Xarid Qilish
                        </button>
                    </form>
                {% endif %}

                {% if project.get_youtube_id %}
                    <button class="action-btn btn-dark border border-secondary text-white" onclick="openVideoModal()">
                        <i class="fab fa-youtube text-danger"></i> Video Sharh
                    </button>
                {% endif %}
            </div>

            <div class="neon-card p-3 d-flex align-items-center gap-3">
                <a href="{% url 'profile_by_username' project.author.username %}">
                    <img src="{% if project.author.profile.avatar %}{{ project.author.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ project.author.username }}{% endif %}" class="rounded-circle border border-primary" width="40" height="40">
                </a>
                <div style="line-height: 1.2;">
                    <a href="{% url 'profile_by_username' project.author.username %}" class="text-white fw-bold d-block text-decoration-none small">{{ project.author.username }}</a>
                    <small class="text-muted" style="font-size: 10px;">Muallif</small>
                </div>
                <button class="btn btn-sm btn-outline-primary ms-auto rounded-pill px-3" style="font-size: 10px;" onclick="toggleSync()">
                    {% if is_synced %}Ulandi{% else %}Ulanish{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<div class="ai-fab" onclick="toggleAiChat()">
    <i class="fas fa-robot"></i>
</div>

<div class="ai-chat-window" id="aiChatWindow">
    <div class="ai-header">
        <span><i class="fas fa-sparkles me-2"></i>AI Yordamchi</span>
        <button onclick="toggleAiChat()" class="btn btn-sm text-white p-0"><i class="fas fa-times"></i></button>
    </div>

    <div class="ai-messages" id="aiMessages">
        <div class="ai-msg bot">
            Salom! Men ushbu loyiha bo'yicha AI yordamchiman. ü§ñ<br>
            <b>"{{ project.title }}"</b> haqida savolingiz bormi?
        </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">AI javob yozmoqda...</div>

    <div class="ai-input-area">
        <input type="text" id="aiInput" class="ai-input" placeholder="Savol bering..." onkeypress="handleEnter(event)">
        <button class="ai-send-btn" onclick="sendAiMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div id="videoModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; align-items:center; justify-content:center;" onclick="closeVideoModal(event)">
    <div style="position:relative; width:90%; max-width:800px;">
        <span style="position:absolute; top:-40px; right:0; color:#fff; font-size:30px; cursor:pointer;" onclick="closeVideoModal(event)">&times;</span>
        <div class="ratio ratio-16x9">
            <iframe id="youtubeIframe" src="" allowfullscreen></iframe>
        </div>
    </div>
</div>

<script>
    // --- AI CHAT LOGIC ---
    const aiWindow = document.getElementById('aiChatWindow');
    const msgsBox = document.getElementById('aiMessages');
    const aiInput = document.getElementById('aiInput');
    const typing = document.getElementById('typingIndicator');

    function toggleAiChat() {
        if(aiWindow.style.display === 'flex') {
            aiWindow.style.display = 'none';
        } else {
            aiWindow.style.display = 'flex';
            setTimeout(() => aiInput.focus(), 100);
        }
    }

    function handleEnter(e) { if(e.key === 'Enter') sendAiMessage(); }

    function sendAiMessage() {
        const txt = aiInput.value.trim();
        if(!txt) return;

        // User xabari
        addMsg(txt, 'user');
        aiInput.value = '';
        typing.style.display = 'block';

        // Serverga so'rov
        fetch("{% url 'project_ai_ask' project.pk %}", {
            method: "POST",
            headers: { "Content-Type": "application/json" }, // CSRF JS da qo'shish kerak yoki template tag orqali
            body: JSON.stringify({ question: txt })
        })
        .then(res => res.json())
        .then(data => {
            typing.style.display = 'none';
            addMsg(data.answer || "Javob ololmadim.", 'bot');
        })
        .catch(() => {
            typing.style.display = 'none';
            addMsg("Xatolik bo'ldi.", 'bot');
        });
    }

    function addMsg(txt, type) {
        const div = document.createElement('div');
        div.className = `ai-msg ${type}`;
        div.innerHTML = txt.replace(/\n/g, '<br>');
        msgsBox.appendChild(div);
        msgsBox.scrollTop = msgsBox.scrollHeight;
    }

    // --- VIDEO MODAL ---
    function openVideoModal() {
        const vidId = "{{ project.get_youtube_id }}";
        if(vidId) {
            document.getElementById('youtubeIframe').src = "https://www.youtube.com/embed/" + vidId + "?autoplay=1";
            document.getElementById('videoModal').style.display = "flex";
        }
    }
    function closeVideoModal(e) {
        if(e.target === e.currentTarget || e.target.classList.contains('close-modal')) {
            document.getElementById('videoModal').style.display = "none";
            document.getElementById('youtubeIframe').src = "";
        }
    }

    // --- COPY CODE ---
    function copyCode() {
        const code = document.getElementById('sourceCode').innerText;
        navigator.clipboard.writeText(code).then(() => {
            const btn = document.getElementById('copyBtn');
            btn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => btn.innerHTML = '<i class="fas fa-copy me-1"></i> Nusxalash', 2000);
        });
    }

    // --- SAVE & LIKE (Qisqa versiya) ---
    // Bu yerga oldingi skriptlardan fetch logikasini qo'shib qo'ying (save_project, like_project)
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
{% endblock %}