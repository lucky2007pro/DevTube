{% extends 'base.html' %}
{% load static %}

{% block title %}Chat: {{ target_user.username }} | DevTube{% endblock %}

{% block content %}
<style>
    /* Chat Karta Dizayni */
    .chat-card {
        background: rgba(15, 23, 42, 0.65);
        backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        overflow: hidden;
        height: 75vh; /* Ekran balandligiga moslash */
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
    }

    body.light-mode .chat-card {
        background: rgba(255, 255, 255, 0.85);
        border-color: #cbd5e1;
    }

    /* Header */
    .chat-header {
        padding: 15px 20px;
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    body.light-mode .chat-header {
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }

    /* Chat Body */
    .chat-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        background: rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Scrollbar */
    .chat-body::-webkit-scrollbar { width: 5px; }
    .chat-body::-webkit-scrollbar-thumb { background: var(--neon-primary); border-radius: 10px; }

    /* Xabarlar Bubbles */
    .msg-row {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        max-width: 80%;
        animation: slideIn 0.3s ease;
    }

    .msg-row.me {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .msg-content {
        padding: 12px 18px;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.5;
        position: relative;
        word-wrap: break-word;
    }

    /* O'zimning xabarim */
    .msg-row.me .msg-content {
        background: linear-gradient(135deg, var(--neon-primary), var(--neon-secondary));
        color: white;
        border-bottom-right-radius: 2px;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    /* Boshqalarning xabari */
    .msg-row.other .msg-content {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        color: #e2e8f0;
        border-bottom-left-radius: 2px;
    }

    body.light-mode .msg-row.other .msg-content {
        background: #ffffff;
        color: #334155;
        border-color: #e2e8f0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* Footer (Input) */
    .chat-footer {
        padding: 15px 20px;
        background: rgba(255, 255, 255, 0.03);
        border-top: 1px solid var(--glass-border);
    }

    body.light-mode .chat-footer {
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
    }

    .chat-input {
        background: rgba(255, 255, 255, 0.05) !important;
        border: 1px solid var(--glass-border) !important;
        color: white !important;
        border-radius: 50px !important;
        padding: 12px 20px;
    }

    body.light-mode .chat-input {
        background: #ffffff !important;
        border-color: #cbd5e1 !important;
        color: #334155 !important;
    }

    .chat-input:focus {
        border-color: var(--neon-primary) !important;
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
    }

    .btn-send {
        width: 45px; height: 45px;
        border-radius: 50%;
        background: var(--neon-primary);
        color: white; border: none;
        display: flex; align-items: center; justify-content: center;
        transition: 0.3s;
        box-shadow: 0 0 10px rgba(99, 102, 241, 0.4);
    }

    .btn-send:hover {
        transform: scale(1.1);
        background: var(--neon-secondary);
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="container py-4" style="max-width: 900px;">

    <div class="chat-card">
        <div class="chat-header">
            <div class="d-flex align-items-center gap-3">
                <a href="{% url 'inbox' %}" class="btn btn-sm btn-outline-secondary rounded-circle" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-arrow-left"></i>
                </a>

                <div class="position-relative">
                    <img src="{% if target_user.profile.avatar %}{{ target_user.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ target_user.username }}{% endif %}" class="rounded-circle border border-2 border-secondary" width="45" height="45" style="object-fit: cover;">
                    <span class="position-absolute bottom-0 end-0 bg-success border border-dark rounded-circle" style="width: 12px; height: 12px;"></span>
                </div>

                <div>
                    <h5 class="mb-0 fw-bold text-white d-flex align-items-center gap-2">
                        {{ target_user.username }}
                        {% if target_user.profile.is_verified %}
                            <i class="fas fa-check-circle text-primary small"></i>
                        {% endif %}
                    </h5>
                    <small class="text-success" style="font-size: 0.8rem;">‚óè Online</small>
                </div>
            </div>

            <div class="dropdown">
                <button class="btn btn-link text-muted" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                <ul class="dropdown-menu dropdown-menu-end bg-dark border-secondary">
                    <li><a class="dropdown-item text-light" href="{% url 'public_profile' target_user.username %}">Profilni ko'rish</a></li>
                    <li><a class="dropdown-item text-danger" href="#">Bloklash</a></li>
                </ul>
            </div>
        </div>

        <div class="chat-body" id="chatBox">
            {% for msg in messages %}
                <div class="msg-row {% if msg.sender == request.user %}me{% else %}other{% endif %}">

                    {% if msg.sender != request.user %}
                        <img src="{% if msg.sender.profile.avatar %}{{ msg.sender.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ msg.sender.username }}{% endif %}" class="rounded-circle shadow-sm" width="30" height="30" style="object-fit: cover;">
                    {% endif %}

                    <div class="msg-content shadow-sm">
                        <p class="mb-1 m-0">{{ msg.body }}</p>
                        <div class="text-end" style="opacity: 0.7; font-size: 0.7rem; margin-top: 4px;">
                            {{ msg.created_at|date:"H:i" }}
                            {% if msg.sender == request.user %}
                                <i class="fas fa-check-double ms-1"></i>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-center text-muted mt-5 d-flex flex-column align-items-center" id="empty-state">
                    <div class="bg-secondary bg-opacity-10 p-4 rounded-circle mb-3">
                        <i class="far fa-paper-plane fa-3x text-secondary"></i>
                    </div>
                    <h5>Suhbatni boshlang!</h5>
                    <p class="small">Birinchi bo'lib salom bering.</p>
                </div>
            {% endfor %}
        </div>

        <div class="chat-footer">
            <form id="chatForm" class="d-flex align-items-center gap-3">
                {% csrf_token %}
                <button type="button" class="btn btn-link text-muted fs-5 p-0"><i class="fas fa-paperclip"></i></button>
                <input type="text" name="body" id="msgInput" class="form-control chat-input" placeholder="Xabar yozing..." required autocomplete="off">
                <button type="submit" class="btn-send"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chatBox');
    const chatForm = document.getElementById('chatForm');
    const msgInput = document.getElementById('msgInput');
    const emptyState = document.getElementById('empty-state');

    // 1. Sahifa ochilganda eng pastga tushirish
    chatBox.scrollTop = chatBox.scrollHeight;

    // 2. Xabar yuborish
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const body = msgInput.value.trim();
        if (!body) return;

        const formData = new FormData(chatForm);

        // Optimistik UI (Userga darrov ko'rsatish)
        // Bu yerda kutib o'tirmasdan xabarni chiqarib qo'yamiz, keyin serverga yuboramiz.
        // Hozircha oddiy fetch ishlatamiz.

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                // Agar "bo'sh holat" bo'lsa olib tashlaymiz
                if(emptyState) emptyState.remove();

                // Yangi xabar HTMLi
                const html = `
                <div class="msg-row me">
                    <div class="msg-content shadow-sm">
                        <p class="mb-1 m-0">${data.body}</p>
                        <div class="text-end" style="opacity: 0.7; font-size: 0.7rem; margin-top: 4px;">
                            ${data.time} <i class="fas fa-check ms-1"></i>
                        </div>
                    </div>
                </div>`;

                chatBox.insertAdjacentHTML('beforeend', html);
                msgInput.value = ''; // Inputni tozalash
                chatBox.scrollTop = chatBox.scrollHeight; // Pastga tushirish
            }
        });
    });
</script>
{% endblock %}