{% extends 'base.html' %}
{% load static %}

{% block title %}Community Chat | DevTube{% endblock %}

{% block content %}
<style>
    /* Chat Sahifasi uchun Maxsus Stillar */
    .chat-wrapper {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        height: 80vh; /* Ekran balandligiga moslash */
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid var(--glass-border);
        padding: 15px 25px;
    }

    .chat-window {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        scroll-behavior: smooth;
        background: rgba(0, 0, 0, 0.2);
    }

    /* Scrollbar dizayni */
    .chat-window::-webkit-scrollbar { width: 6px; }
    .chat-window::-webkit-scrollbar-thumb { background: var(--neon-primary); border-radius: 10px; }
    .chat-window::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }

    .chat-footer {
        padding: 15px 20px;
        background: rgba(255, 255, 255, 0.03);
        border-top: 1px solid var(--glass-border);
    }

    .chat-input {
        background: rgba(0, 0, 0, 0.3) !important;
        border: 1px solid var(--glass-border) !important;
        color: white !important;
        border-radius: 50px !important;
        padding-left: 20px;
        padding-right: 20px;
    }

    .chat-input:focus {
        border-color: var(--neon-primary) !important;
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
    }

    .btn-send {
        background: linear-gradient(135deg, var(--neon-primary), var(--neon-secondary));
        border: none;
        color: white;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.3s;
        box-shadow: 0 0 10px rgba(99, 102, 241, 0.4);
    }

    .btn-send:hover {
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.7);
    }
</style>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <div class="chat-wrapper">
                <div class="chat-header d-flex align-items-center justify-content-between">
                    <h5 class="m-0 text-white fw-bold">
                        <i class="fas fa-comments text-primary me-2"></i> Dasturchilar Chati
                    </h5>
                    <div class="d-flex align-items-center gap-2">
                        <span class="pulse-dot"></span>
                        <span class="badge bg-success bg-opacity-20 text-success border border-success border-opacity-25 rounded-pill px-3">
                            ‚óè Online
                        </span>
                    </div>
                </div>

                <div id="chat-window" class="chat-window">
                    {% include 'chat_messages_partial.html' %}
                </div>

                <div class="chat-footer">
                    <form id="chat-form" class="d-flex align-items-center gap-3">
                        {% csrf_token %}
                        <input type="text" id="msg-body" name="body" class="form-control chat-input py-3" placeholder="Xabar yozing..." autocomplete="off">
                        <button type="submit" class="btn-send">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const msgInput = document.getElementById('msg-body');

        // 1. Sahifa ochilganda eng pastga tushirish
        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        scrollToBottom();

        // 2. Xabar yuborish (AJAX)
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const body = msgInput.value.trim();
            if (!body) return; // Bo'sh xabar ketmasligi uchun

            const formData = new FormData(chatForm);

            // Fetch orqali yuborish
            fetch("{% url 'community_chat' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.html) {
                    // Chatni yangilash
                    chatWindow.innerHTML = data.html;
                    msgInput.value = ''; // Inputni tozalash
                    scrollToBottom(); // Pastga tushirish
                }
            })
            .catch(error => console.error('Xatolik:', error));
        });

        // 3. Real vaqtda yangilash (Polling - har 3 soniyada)
        setInterval(() => {
            fetch("{% url 'community_chat' %}", {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.html) {
                    // Foydalanuvchi qayerda turganini tekshirish
                    // Agar u teparoqqa chiqib tarixni o'qiyotgan bo'lsa, uni majburlab pastga tushirmaslik kerak.
                    const isAtBottom = chatWindow.scrollHeight - chatWindow.scrollTop <= chatWindow.clientHeight + 150;

                    // HTMLni yangilash
                    // Eslatma: Bu usul butun chatni yangilaydi. Katta chatlarda "append" qilish yaxshiroq,
                    // lekin hozircha partial replace eng oson yo'li.
                    if (chatWindow.innerHTML !== data.html) {
                        chatWindow.innerHTML = data.html;

                        // Agar user pastda turgan bo'lsa, yangi xabar kelganda pastga tushiramiz
                        if(isAtBottom) {
                            scrollToBottom();
                        }
                    }
                }
            });
        }, 3000); // 3000ms = 3 soniya
    });
</script>
{% endblock %}